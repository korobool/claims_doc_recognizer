<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document Recognition System</title>
    <link rel="stylesheet" href="/static/css/style.css?v=28">
</head>
<body>
    <div class="container">
        <!-- Left panel: upload and image list -->
        <aside class="sidebar left-panel">
            <div class="left-panel-content">
                <div class="panel-header">
                    <h2>Document Library</h2>
                </div>
                <div class="upload-area" id="uploadArea">
                    <input type="file" id="fileInput" multiple accept="image/*" hidden>
                    <button class="btn btn-primary btn-upload" onclick="document.getElementById('fileInput').click()">
                        <span class="btn-icon">+</span> Upload Documents
                    </button>
                    <p class="hint">or drag and drop files here</p>
                </div>
                <div class="image-list" id="imageList">
                    <!-- List of uploaded images -->
                </div>
            </div>
        </aside>

        <!-- Center panel: view and process -->
        <main class="main-panel">
            <!-- Main area tabs -->
            <div class="main-tabs">
                <button class="main-tab active" data-tab="viewer" id="viewerTabBtn">
                    <span class="tab-icon">üìÑ</span> Document Viewer
                </button>
                <button class="main-tab" data-tab="llm" id="llmTabBtn">
                    <span class="tab-icon">ü§ñ</span> LLM Results
                </button>
                <button class="main-tab" data-tab="schemas" id="schemasTabBtn">
                    <span class="tab-icon">üìã</span> Templates
                </button>
                <button class="main-tab" data-tab="settings" id="settingsTabBtn">
                    <span class="tab-icon">‚öôÔ∏è</span> Settings
                </button>
            </div>
            
            <!-- Document Viewer Tab -->
            <div class="main-tab-content active" id="viewerTab">
                <!-- Viewer Toolbar - context-specific actions -->
                <div class="tab-toolbar" id="viewerToolbar">
                    <div class="toolbar-group">
                        <button class="btn btn-toolbar" id="normalizeBtn" disabled title="Auto-rotate and deskew">
                            <span class="btn-icon">üîÑ</span> Normalize
                        </button>
                        <button class="btn btn-toolbar btn-primary" id="recognizeBtn" disabled title="Run OCR recognition">
                            <span class="btn-icon">üîç</span> Recognize
                        </button>
                        <button class="btn btn-toolbar" id="addBboxBtn" disabled title="Draw custom text region">
                            <span class="btn-icon">‚úèÔ∏è</span> Add Region
                        </button>
                    </div>
                    <div class="toolbar-separator"></div>
                    <div class="toolbar-group zoom-toolbar">
                        <button class="btn btn-icon-only" id="zoomOutBtn" title="Zoom out (Ctrl+-)">‚àí</button>
                        <input type="range" id="zoomSlider" min="25" max="300" value="100" step="5">
                        <button class="btn btn-icon-only" id="zoomInBtn" title="Zoom in (Ctrl++)">+</button>
                        <span class="zoom-value" id="zoomValue">100%</span>
                    </div>
                </div>
                
                <div class="image-viewer" id="imageViewer">
                    <div class="placeholder" id="placeholder">
                        <div class="placeholder-content">
                            <span class="placeholder-icon">üìÑ</span>
                            <p class="placeholder-text">Select a document to view</p>
                            <p class="placeholder-hint">Upload documents using the panel on the left</p>
                        </div>
                    </div>
                    <div class="zoom-wrapper" id="zoomWrapper" style="display: none;">
                        <div class="image-container" id="imageContainer">
                            <img id="mainImage" src="" alt="Document">
                            <div class="text-overlay" id="textOverlay">
                                <!-- Editable text blocks -->
                            </div>
                        </div>
                    </div>
                </div>
            </div><!-- End viewerTab -->
            
            <!-- Schema Templates Tab -->
            <div class="main-tab-content" id="schemasTab">
                <div class="schemas-container">
                    <div class="schemas-sidebar">
                        <h3>Document Templates</h3>
                        <div class="schema-list" id="schemaList">
                            <!-- Schema items loaded dynamically -->
                        </div>
                        <button class="btn btn-primary btn-full" id="newSchemaBtn">
                            ‚ûï New Template
                        </button>
                    </div>
                    <div class="schema-editor">
                        <div class="schema-editor-header">
                            <h3 id="schemaEditorTitle">Select a template</h3>
                            <div class="schema-editor-actions">
                                <button class="btn btn-small" id="saveSchemaBtn" disabled>üíæ Save</button>
                                <button class="btn btn-small btn-danger" id="deleteSchemaBtn" disabled>üóëÔ∏è Delete</button>
                            </div>
                        </div>
                        
                        <div class="schema-placeholder" id="schemaPlaceholder">
                            <p>Select a template from the list or create a new one</p>
                        </div>
                        
                        <div class="schema-edit-form" id="schemaEditForm" style="display: none;">
                            <!-- LLM Generation Section -->
                            <div class="schema-llm-section">
                                <label>Generate with AI:</label>
                                <div class="schema-llm-input">
                                    <textarea id="schemaDescription" placeholder="Describe the document type you want to create, e.g., 'A bank statement with account info, transactions list, and balance'"></textarea>
                                    <button class="btn btn-primary" id="generateSchemaBtn">ü§ñ Generate</button>
                                </div>
                                <p class="hint">Uses model selected in Settings tab</p>
                            </div>
                            
                            <div class="schema-divider">
                                <span>or edit manually</span>
                            </div>
                            
                            <!-- YAML Editor -->
                            <div class="schema-yaml-section">
                                <label>Schema YAML:</label>
                                <textarea id="schemaYamlEditor" class="yaml-editor" spellcheck="false"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div><!-- End schemasTab -->
            
            <!-- LLM Results Tab -->
            <div class="main-tab-content" id="llmMainTab">
                <!-- LLM Toolbar -->
                <div class="tab-toolbar" id="llmToolbar">
                    <div class="toolbar-group">
                        <button class="btn btn-toolbar btn-primary" id="processLlmBtnMain" disabled>
                            <span class="btn-icon">ü§ñ</span> Process with LLM
                        </button>
                    </div>
                    <div class="toolbar-info">
                        <span class="model-label">Model:</span>
                        <strong id="llmSelectedModelDisplay">No model selected</strong>
                        <span class="vision-indicator" id="llmVisionIndicator" style="display: none;">üëÅÔ∏è</span>
                    </div>
                </div>
                
                <div class="llm-results-container">
                    <div class="llm-result-panel">
                        <div class="llm-placeholder" id="llmPlaceholderMain">
                            <div class="placeholder-content">
                                <span class="placeholder-icon">ü§ñ</span>
                                <p class="placeholder-text">Ready to enhance OCR results</p>
                                <p class="placeholder-hint">Run OCR first, then click "Process with LLM" to extract structured data</p>
                            </div>
                        </div>
                        <div class="llm-result" id="llmResultMain" style="display: none;">
                            <div class="llm-section" id="llmExtractedFieldsSectionMain">
                                <div class="section-header">
                                    <h4>üìã Extracted Fields</h4>
                                    <span class="doc-type-badge" id="llmDocTypeBadgeMain"></span>
                                </div>
                                <div class="extracted-fields" id="llmExtractedFieldsMain"></div>
                            </div>
                            <div class="llm-section">
                                <div class="section-header">
                                    <h4>üìù Corrected Text</h4>
                                </div>
                                <div class="llm-text" id="llmEnhancedTextMain"></div>
                            </div>
                            <div class="llm-section" id="llmConfidenceSectionMain" style="display: none;">
                                <div class="section-header">
                                    <h4>‚ÑπÔ∏è Notes</h4>
                                </div>
                                <div class="llm-notes" id="llmConfidenceNotesMain"></div>
                            </div>
                            <div class="llm-meta">
                                <div class="meta-item">
                                    <span class="meta-label">Model:</span>
                                    <strong id="llmModelUsedMain">-</strong>
                                </div>
                                <div class="meta-item">
                                    <span class="meta-label">Document:</span>
                                    <strong id="llmDocTypeMain">-</strong>
                                </div>
                                <div class="meta-item" id="llmTimingMeta" style="display: none;">
                                    <span class="meta-label">Time:</span>
                                    <strong id="llmProcessingTime">-</strong>
                                </div>
                                <div class="meta-item" id="llmTokensMeta" style="display: none;">
                                    <span class="meta-label">Tokens:</span>
                                    <strong id="llmTokenCount">-</strong>
                                </div>
                            </div>
                        </div>
                        <div class="llm-loading" id="llmLoadingMain" style="display: none;">
                            <div class="spinner"></div>
                            <p>Connecting to LLM...</p>
                            <p class="loading-timer" id="llmLoadingTimer">0.0s</p>
                        </div>
                    </div>
                </div>
            </div><!-- End llmMainTab -->
            
            <!-- Settings Tab -->
            <div class="main-tab-content" id="settingsTab">
                <div class="settings-container">
                    <div class="settings-section">
                        <h3>ü§ñ LLM Configuration</h3>
                        <div class="settings-card">
                            <div class="settings-row">
                                <div class="llm-status" id="llmStatusSettings">
                                    <span class="status-indicator" id="ollamaStatusSettings">‚ö™</span>
                                    <span id="ollamaStatusTextSettings">Checking Ollama...</span>
                                </div>
                                <button class="btn btn-small btn-start-ollama" id="startOllamaBtn" style="display: none;" title="Start Ollama service">
                                    ‚ñ∂Ô∏è Start Ollama
                                </button>
                                <div class="llm-acceleration" id="llmAccelerationSettings">
                                    <span class="accel-icon" id="accelIconSettings">‚ö°</span>
                                    <span id="accelTextSettings">Checking acceleration...</span>
                                </div>
                            </div>
                            <div class="settings-row">
                                <label for="llmModelSelect">Select Model:</label>
                                <div class="model-select-row">
                                    <select id="llmModelSelect" disabled>
                                        <option value="">Loading...</option>
                                    </select>
                                    <button class="btn btn-small" id="pullModelBtn" disabled title="Pull model if not available">
                                        ‚¨áÔ∏è Pull
                                    </button>
                                </div>
                            </div>
                            <div class="model-capabilities" id="modelCapabilities" style="display: none;">
                                <span class="capability-badge vision-badge" id="visionBadge" style="display: none;">
                                    üëÅÔ∏è Vision Enabled
                                </span>
                                <span class="capability-badge text-badge" id="textOnlyBadge" style="display: none;">
                                    üìù Text Only
                                </span>
                                <span class="capability-badge medical-badge" id="medicalBadge" style="display: none;">
                                    üè• Medical Specialized
                                </span>
                            </div>
                            <div class="pull-progress" id="pullProgress" style="display: none;">
                                <div class="progress-bar">
                                    <div class="progress-fill" id="pullProgressFill"></div>
                                </div>
                                <span class="progress-text" id="pullProgressText">Downloading...</span>
                            </div>
                            <div class="settings-note">
                                Selected model will be used for LLM processing and schema generation.
                                <br><small>üëÅÔ∏è Vision models can see the document image for better accuracy.</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div><!-- End settingsTab -->
        </main>

        <!-- Right panel: Results & Activity -->
        <aside class="sidebar right-panel">
            <div class="panel-header">
                <h2>Output & Activity</h2>
            </div>
            
            <!-- Right Panel Tabs -->
            <div class="right-panel-tabs">
                <button class="rp-tab active" data-rp-tab="ocr" id="rpOcrTabBtn">
                    <span class="rp-tab-icon">üìù</span> OCR
                </button>
                <button class="rp-tab" data-rp-tab="activity" id="rpActivityTabBtn">
                    <span class="rp-tab-icon">üìã</span> Activity
                    <span class="activity-indicator" id="activityIndicator"></span>
                </button>
                <button class="rp-tab" data-rp-tab="llm-raw" id="rpLlmRawTabBtn">
                    <span class="rp-tab-icon">ü§ñ</span> LLM Raw
                    <span class="llm-streaming-indicator" id="llmStreamingIndicator"></span>
                </button>
            </div>
            
            <!-- OCR Tab Content -->
            <div class="rp-tab-content active" id="rpOcrTab">
                <div class="device-info-container" id="deviceInfoContainer">
                    <div class="device-info-header" onclick="toggleDeviceInfo()">
                        <span class="device-info-icon">‚ö°</span>
                        <span class="device-info-title">System</span>
                        <span class="device-info-status" id="deviceInfoStatus">Loading...</span>
                        <span class="device-info-toggle" id="deviceInfoToggle">‚ñº</span>
                    </div>
                    <div class="device-info-details" id="deviceInfoDetails" style="display: none;">
                        <div class="device-info-row">
                            <span class="device-label">PyTorch:</span>
                            <span class="device-value" id="pytorchVersion">-</span>
                        </div>
                        <div class="device-info-row" id="pytorchCudaRow">
                            <span class="device-label">CUDA Build:</span>
                            <span class="device-value" id="pytorchCudaBuild">-</span>
                        </div>
                        <div class="device-info-separator"></div>
                        <div class="device-info-row acceleration-row">
                            <span class="device-label">Acceleration:</span>
                            <span class="device-value" id="accelerationType">-</span>
                        </div>
                        <div class="device-info-row">
                            <span class="device-label">Device:</span>
                            <span class="device-value" id="selectedDevice">-</span>
                        </div>
                        <div class="device-info-row" id="cudaVersionRow" style="display: none;">
                            <span class="device-label">CUDA Version:</span>
                            <span class="device-value" id="cudaVersion">-</span>
                        </div>
                        <div class="device-info-row" id="gpuCountRow" style="display: none;">
                            <span class="device-label">GPU Count:</span>
                            <span class="device-value" id="gpuCount">-</span>
                        </div>
                        <div class="device-info-row" id="gpuNameRow" style="display: none;">
                            <span class="device-label">GPU:</span>
                            <span class="device-value" id="gpuName">-</span>
                        </div>
                        <div class="device-info-row" id="gpuMemoryRow" style="display: none;">
                            <span class="device-label">GPU Memory:</span>
                            <span class="device-value" id="gpuMemory">-</span>
                        </div>
                        <div class="device-info-separator"></div>
                        <div class="device-info-row">
                            <span class="device-label">Surya OCR:</span>
                            <span class="device-value" id="suryaDevice">Pending</span>
                        </div>
                        <div class="device-info-row">
                            <span class="device-label">SigLIP:</span>
                            <span class="device-value" id="clipDevice">Pending</span>
                        </div>
                        <div class="device-info-note" id="deviceInfoNote">Models load on first recognition</div>
                    </div>
                </div>
                
                <div class="document-class-container" id="documentClassContainer" style="display: none;">
                    <span class="document-class-label">Document Type:</span>
                    <span class="document-class-value" id="documentClassValue">-</span>
                    <span class="document-class-confidence" id="documentClassConfidence"></span>
                </div>
                
                <!-- OCR Timing Info -->
                <div class="timing-info" id="ocrTimingInfo" style="display: none;">
                    <span class="timing-label">OCR completed in</span>
                    <span class="timing-value" id="ocrTimingValue">-</span>
                </div>
                
                <!-- JSON Results -->
                <div class="results-section">
                    <div class="results-header-row">
                        <h3 class="results-header">Raw OCR Output</h3>
                        <span class="line-count" id="lineCount">0 lines</span>
                    </div>
                    <div class="json-container">
                        <pre id="jsonOutput" contenteditable="false">{
  "text_lines": [],
  "image_bbox": []
}</pre>
                    </div>
                </div>
            </div>
            
            <!-- Activity Log Tab Content -->
            <div class="rp-tab-content" id="rpActivityTab">
                <div class="activity-log-container">
                    <div class="activity-log-header">
                        <span class="activity-title">Activity Log</span>
                        <button class="btn btn-icon-only btn-small" id="clearActivityBtn" title="Clear log">üóëÔ∏è</button>
                    </div>
                    <div class="activity-log-entries" id="activityLogEntries">
                        <div class="log-entry log-info">
                            <span class="log-time">--:--:--</span>
                            <span class="log-message">System ready. Upload an image to begin.</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- LLM Raw Output Tab Content -->
            <div class="rp-tab-content" id="rpLlmRawTab">
                <div class="llm-raw-container">
                    <div class="llm-raw-header">
                        <div class="llm-raw-status" id="llmRawStatus">
                            <span class="status-dot idle" id="llmStatusDot"></span>
                            <span class="status-text" id="llmStatusText">Idle</span>
                        </div>
                        <div class="llm-raw-meta">
                            <span class="meta-badge" id="llmModeBadge" style="display: none;">Text</span>
                            <span class="meta-badge" id="llmModelBadge" style="display: none;">Model</span>
                        </div>
                    </div>
                    <div class="llm-raw-stats" id="llmRawStats" style="display: none;">
                        <div class="stat-item">
                            <span class="stat-label">Tokens:</span>
                            <span class="stat-value" id="llmRawTokens">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Time:</span>
                            <span class="stat-value" id="llmRawTime">0.0s</span>
                        </div>
                    </div>
                    <div class="llm-raw-output" id="llmRawOutput">
                        <div class="llm-raw-placeholder">
                            <span class="placeholder-icon">ü§ñ</span>
                            <p>LLM output will appear here during processing</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="panel-footer">
                <button class="btn btn-success" id="saveBtn" disabled>
                    <span class="btn-icon">üíæ</span> Export JSON
                </button>
            </div>
        </aside>
    </div>

    <script src="/static/js/app.js?v=28"></script>
</body>
</html>
